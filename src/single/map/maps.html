<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Click the Region ‚Äì Exercise</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
<style>
  html,body { height: 100%; margin: 0; background-color: black}
  #map { height: 80%; width: 80% }
  .ui {
    position: absolute; inset: 10px auto auto 10px; z-index: 1000;
    display: grid; gap: 8px; max-width: min(520px, 90vw);
    background: #fff; padding: 10px; border-radius: 10px;
    box-shadow: 0 6px 24px rgba(0,0,0,.15); font: 14px system-ui, sans-serif;
  }
  .row { display: grid; gap: 6px; }
  .prompt { font-weight: 700; font-size: 1rem; }
  .subtle { opacity: .8 }
  .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f4f6; font-size:.8rem; }
  .ok { color: #16a34a; } .err { color: #dc2626; }
  .controls { display:flex; gap:8px; flex-wrap: wrap; align-items: center; }
  textarea { width: 100%; min-height: 110px; font: 12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  button { cursor: pointer; padding: 6px 10px; border-radius: 8px; border:1px solid #ddd; background:#fafafa; }
  button.primary { background:#111827; color:#fff; border-color:#111827; }
  .progress { height: 8px; background:#eef2ff; border-radius: 999px; overflow: hidden; }
  .progress > div { height: 100%; background:#6366f1; width:0%; transition: width .25s ease; }
  /* Result overlay */
  .overlay {
    position: absolute; inset: 0; display:none; place-items: center; z-index: 1500;
    background: rgba(0,0,0,.45);
  }
  .card {
    background:#fff; color:#111; width: min(720px, 92vw); border-radius: 16px; padding: 16px;
    box-shadow: 0 12px 40px rgba(0,0,0,.35); display: grid; gap: 12px;
  }
  .summary { display: grid; gap: 8px; max-height: 46vh; overflow: auto; }
  .sum-row { display:flex; justify-content: space-between; gap:12px; border:1px solid #eee; padding:8px; border-radius:10px }
  .sum-row .name { font-weight:600 }
</style>
</head>
<body>
<div id="map"></div>

<!-- UI -->
<div class="ui">
  <div class="row">
    <div class="prompt" id="prompt">Load some regions to start</div>
    <div id="status" class="subtle">Click anywhere to see coordinates.</div>
    <div class="progress"><div id="bar"></div></div>
  </div>

  <div class="row">
    <label class="subtle">Custom REGIONS (GeoJSON FeatureCollection or array of Features):</label>
    <textarea id="regionsInput">[
  {
    "type": "Feature",
    "properties": { "name": "Egypt", "color": "#16a34a" },
    "geometry": { "type": "Polygon", "coordinates": [[[24,22],[36,22],[36,32],[24,32],[24,22]]] }
  },
  {
    "type": "Feature",
    "properties": { "name": "Amazing Rainforest", "color": "#22c55e" },
    "geometry": { "type": "Polygon", "coordinates": [[[-70,-8],[-66,-8],[-66,-4],[-70,-4],[-70,-8]]] }
  }
]</textarea>
    <div class="controls">
      <button id="loadBtn" class="primary">Load Regions</button>
      <button id="restartBtn" title="Restart exercise">Restart</button>
      <span id="count" class="badge">0 regions</span>
    </div>
  </div>
</div>

<!-- Result overlay -->
<div class="overlay" id="overlay">
  <div class="card">
    <h2 style="margin:0">Exercise Results</h2>
    <div id="scoreline" class="subtle"></div>
    <div class="summary" id="summary"></div>
    <div class="controls">
      <button id="closeOverlay" class="primary">Close</button>
      <button id="retryOverlay">Retry</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script>
(() => {
  // --- Map init with planet-safe bounds/zoom --------------------------------
  const WORLD = L.latLngBounds([[-85, -180], [85, 180]]); // clip poles a bit for nicer zoom calc
  const map = L.map('map', {
    worldCopyJump: true,
    maxBounds: WORLD,
    maxBoundsViscosity: 0.9,
    zoomControl: true
  }).setView([20, 0], 2);

  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors', maxZoom: 10
  }).addTo(map);

  // Compute a minZoom that ensures the whole WORLD fits and prevent further zoom-out
  function setMinZoomToWorld() {
    const minZ = map.getBoundsZoom(WORLD, true);
    map.setMinZoom(minZ);
    if (map.getZoom() < minZ) map.setZoom(minZ);
  }
  setMinZoomToWorld();
  window.addEventListener('resize', setMinZoomToWorld);

  // --- UI elements -----------------------------------------------------------
  const $prompt = document.getElementById('prompt');
  const $status = document.getElementById('status');
  const $bar = document.getElementById('bar');
  const $regionsInput = document.getElementById('regionsInput');
  const $loadBtn = document.getElementById('loadBtn');
  const $restartBtn = document.getElementById('restartBtn');
  const $count = document.getElementById('count');

  const $overlay = document.getElementById('overlay');
  const $summary = document.getElementById('summary');
  const $scoreline = document.getElementById('scoreline');
  const $closeOverlay = document.getElementById('closeOverlay');
  const $retryOverlay = document.getElementById('retryOverlay');

  // --- State -----------------------------------------------------------------
  /** @type {Array<{feature: GeoJSON.Feature, name: string, color?: string}>} */
  let REGIONS = [];
  let idx = 0;
  let attemptsLeft = 3;
  let results = []; // { name, correct:boolean, attempts:number }

  // Layers (kept separate so regions stay hidden until correct)
  const paintedLayer = L.geoJSON(null, { style: f => ({
    color: f.properties.__stroke || '#111827',
    weight: 2,
    fillColor: f.properties.__fill || '#3b82f6',
    fillOpacity: 0.35
  })}).addTo(map);

  const missLayer = L.layerGroup().addTo(map); // fading miss markers

  const clickMarker = L.circleMarker([0,0], { radius: 5, weight:2, color:'#111', fill:true, fillOpacity:0.7, opacity:0 }).addTo(map);

  // --- Helpers ---------------------------------------------------------------
  function asFeatureArray(input) {
    if (!input) return [];
    if (input.type === 'FeatureCollection') return input.features || [];
    if (Array.isArray(input)) return input;
    if (input.type === 'Feature') return [input];
    return [];
  }

  function loadRegionsFromTextarea() {
    let raw;
    try {
      raw = JSON.parse($regionsInput.value.trim());
    } catch(e) {
      alert('Invalid JSON in REGIONS textarea.');
      return false;
    }
    const feats = asFeatureArray(raw).filter(f => f && f.geometry);
    REGIONS = feats.map(f => ({
      feature: f,
      name: f.properties?.name ?? 'Untitled',
      color: f.properties?.color
    }));
    $count.textContent = `${REGIONS.length} region${REGIONS.length===1?'':'s'}`;
    startExercise();
    return true;
  }

  function startExercise() {
    idx = 0;
    attemptsLeft = 3;
    results = REGIONS.map(() => null);
    paintedLayer.clearLayers();
    missLayer.clearLayers();
    updateProgress();
    setPrompt();
    // Optional: zoom to world start
    map.fitBounds(WORLD, { animate: false });
  }

  function updateProgress() {
    const total = REGIONS.length || 1;
    const done = Math.min(idx, total);
    $bar.style.width = `${(done/total)*100}%`;
  }

  function setPrompt() {
    if (idx >= REGIONS.length) return showResults();
    const name = REGIONS[idx].name;
    attemptsLeft = 3;
    // Prompt supports emoji flags, etc.
    $prompt.textContent = `Where is ${name}?`;
    $status.innerHTML = `Attempts left: <b>${attemptsLeft}</b>. Click on the map.`;
  }

  function showResults() {
    updateProgress();
    const total = REGIONS.length;
    const correct = results.filter(r => r?.correct).length;
    $scoreline.textContent = `You got ${correct} of ${total} correct.`;
    $summary.innerHTML = '';

    results.forEach((r, i) => {
      const div = document.createElement('div');
      div.className = 'sum-row';
      div.innerHTML = `
        <span class="name">${REGIONS[i].name}</span>
        <span>${r?.correct ? '‚úÖ' : '‚ùå'} <span class="${r?.correct?'ok':'err'}">${r?.correct?'Correct':'Incorrect'}</span>
        ¬∑ Attempts used: ${r?.attempts ?? 3}</span>`;
      $summary.appendChild(div);
    });

    $overlay.style.display = 'grid';
  }

  function hideResults() { $overlay.style.display = 'none'; }

  function fadeMiss(latlng) {
    const cm = L.circleMarker(latlng, { radius: 5, color:'#dc2626', fillColor:'#dc2626', fillOpacity:0.9, opacity:1 });
    missLayer.addLayer(cm);
    let op = 0.9;
    const iv = setInterval(() => {
      op -= 0.1;
      if (op <= 0) { clearInterval(iv); missLayer.removeLayer(cm); }
      else cm.setStyle({ fillOpacity: op, opacity: op });
    }, 80);
  }

  function paintRegion(region) {
    // Clone feature and assign visual props
    const f = JSON.parse(JSON.stringify(region.feature));
    const fill = region.color || '#22c55e';
    f.properties = { ...(f.properties||{}), __fill: fill, __stroke: '#14532d' };
    paintedLayer.addData(f);
  }

  function booleanPointInRegion(point, regionFeature) {
    // Supports Polygon & MultiPolygon
    return turf.booleanPointInPolygon(point, regionFeature);
  }

  // --- Map interaction -------------------------------------------------------
  map.on('click', (e) => {
    const { lat, lng } = e.latlng;
    clickMarker.setLatLng(e.latlng).setStyle({ opacity: 1, fillOpacity: 0.8 });

    // Always show raw coords
    $status.innerHTML = `Clicked: lat <b>${lat.toFixed(6)}</b>, lng <b>${lng.toFixed(6)}</b> ¬∑ Attempts left: <b>${attemptsLeft}</b>`;

    if (idx >= REGIONS.length) return; // finished

    const target = REGIONS[idx];
    const pt = turf.point([lng, lat]);
    const inside = booleanPointInRegion(pt, target.feature);

    if (inside) {
      paintRegion(target);
      results[idx] = { correct: true, attempts: 4 - attemptsLeft };
      idx += 1;
      updateProgress();
      if (idx >= REGIONS.length) {
        $prompt.textContent = 'Done! üéâ';
        showResults();
      } else {
        setPrompt();
      }
    } else {
      attemptsLeft -= 1;
      fadeMiss(e.latlng);
      if (attemptsLeft > 0) {
        $status.innerHTML = `‚ùå Miss. Attempts left: <b>${attemptsLeft}</b>. Try again.`;
      } else {
        // Out of attempts -> mark incorrect and move on
        results[idx] = { correct: false, attempts: 3 };
        idx += 1;
        updateProgress();
        if (idx >= REGIONS.length) {
          $prompt.textContent = 'Done! üéâ';
          showResults();
        } else {
          setPrompt();
        }
      }
    }
  });

  // --- Buttons ---------------------------------------------------------------
  $loadBtn.addEventListener('click', loadRegionsFromTextarea);
  $restartBtn.addEventListener('click', startExercise);
  $closeOverlay.addEventListener('click', () => { hideResults(); });
  $retryOverlay.addEventListener('click', () => { hideResults(); startExercise(); });

  // Initial: load sample
  loadRegionsFromTextarea();
})();
</script>
</body>
</html>

