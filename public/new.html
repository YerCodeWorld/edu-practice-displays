<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Exercise Playground (Scoped)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  	
  	body {
  		margin: 0;
  		background-color: rgb(var(--edu-bg));
  	}  	
  	
    /* ------- PLAYGROUND IS FULLY SCOPED ------- */
    .edu-playground {
      /* occupy viewport without affecting rest of page styles */
      min-height: 100svh;
      display: grid;
      grid-template-rows: auto 1fr auto;
      background: rgb(var(--edu-bg));
      color: rgb(var(--edu-ink));
      font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
      overflow: hidden; /* page never scrolls, only the viewport inside */
    }

    /* local reset (scoped!) */
    .edu-playground :where(h1,h2,h3,h4,h5,h6,p) { margin: 0; }
    .edu-playground :where(*, *::before, *::after) { box-sizing: border-box; }

    /* ----- THEMES (scoped variables) ----- */
    .edu-playground[data-theme="light"] {
      --edu-bg:            247 249 252; /* slate-50 */
      --edu-card:          255 255 255; /* white */

      --edu-ink:           31 41 55;    /* slate-800 */
      --edu-second-ink:    71 85 105;   /* slate-600 */
      --edu-third-ink:     100 116 139; /* slate-500 */

      --edu-inverted-ink:  248 250 252;

      --edu-success:       22 163 74;   /* green-600 */
      --edu-error:         220 38 38;   /* red-600 */
      --edu-neutral:       14 165 233;  /* sky-500 */

      --edu-first-accent:  99 102 241;  /* indigo-500 */
      --edu-second-accent: 245 158 11;  /* amber-500 */
      --edu-third-accent:  236 72 153;  /* pink-500 */

      --edu-border:        229 231 235; /* slate-200 */
      --edu-muted:         243 244 246; /* slate-100 */

      --edu-radius:        0.375rem;
      --edu-shadow-color:  0 0 0;
    }

    .edu-playground[data-theme="dark"] {
      --edu-bg:            17 24 39;    /* slate-900 */
      --edu-card:          31 41 55;    /* slate-800 */

      --edu-ink:           248 250 252; /* slate-50 */
      --edu-second-ink:    203 213 225; /* slate-300 */
      --edu-third-ink:     148 163 184; /* slate-400 */

      --edu-inverted-ink:  31 41 55;

      --edu-success:       34 197 94;   /* green-500 */
      --edu-error:         239 68 68;   /* red-500 */
      --edu-neutral:       56 189 248;  /* sky-400 */

      --edu-first-accent:  129 140 248; /* indigo-400 */
      --edu-second-accent: 251 191 36;  /* amber-400 */
      --edu-third-accent:  244 114 182; /* pink-400 */

      --edu-border:        51 65 85;    /* slate-700 */
      --edu-muted:         30 41 59;    /* slate-800 */

      --edu-radius:        0.375rem;
      --edu-shadow-color:  0 0 0;
    }

    /* ----- HEADER ----- */
    .pg-header {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 12px;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid rgb(var(--edu-border));
      background: rgb(var(--edu-card));
    }

    .pg-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .pg-select, .pg-textarea, .pg-button, .pg-input, .pg-toggle {
      border: 1px solid rgb(var(--edu-border));
      background: rgb(var(--edu-card));
      color: rgb(var(--edu-ink));
      border-radius: var(--edu-radius);
    }

    .pg-select, .pg-input {
      height: 36px;
      padding: 0 10px;
    }

    .pg-button {
      padding: 8px 12px;
      cursor: pointer;
      font-weight: 600;
    }

    .pg-button:hover {
      outline: 2px solid rgb(var(--edu-first-accent) / .35);
      outline-offset: 2px;
    }

    .pg-accent {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgb(var(--edu-border));
      cursor: pointer;
    }

    .pg-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 8px;
      user-select: none;
      cursor: pointer;
    }

    /* ----- APP AREA ----- */
    .pg-app {
      min-height: 0; /* critical so children can shrink */
      overflow: hidden;
      display: grid;
      grid-template-columns: minmax(280px, 420px) 1fr;
      gap: 0;
    }

    /* Left pane (controls) */
    .pg-controls {
      border-right: 1px solid rgb(var(--edu-border));
      background: rgb(var(--edu-card));
      min-height: 0;
      overflow: auto;
      padding: 12px;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 12px;
    }

    .pg-textarea {
      width: 100%;
      height: 100%;
      resize: none;
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      line-height: 1.5;
      background: rgb(var(--edu-muted));
      border-color: rgb(var(--edu-border));
    }

    .pg-controls .pg-row.bottom {
      justify-content: space-between;
    }

    /* Right pane (viewport) */
    .pg-viewport-wrap {
      min-height: 0;
      overflow: hidden;
      display: grid;
      grid-template-rows: auto 1fr;
    }

    .pg-switcher {
      display: flex;
      gap: 8px;
      padding: 12px;
      border-bottom: 1px solid rgb(var(--edu-border));
      background: rgb(var(--edu-card));
    }

    .pg-viewport {
      min-height: 0;
      max-height: 100%;
      overflow: auto; /* only this area scrolls */
      padding: 12px;
      background:
        radial-gradient(transparent 1px, rgb(var(--edu-bg)) 1px) 0 0 / 12px 12px,
        radial-gradient(transparent 1px, rgb(var(--edu-bg)) 1px) 6px 6px / 12px 12px,
        rgb(var(--edu-bg));
    }

    /* The actual mount for renderers; gets theme variables via cascade */
    .pg-mount {
      background: rgb(var(--edu-card) / 0.9);
      border: 1px solid rgb(var(--edu-border));
      border-radius: calc(var(--edu-radius) + 2px);
      box-shadow: 0 10px 25px rgba(var(--edu-shadow-color) / 0.12);
      padding: 16px;
      min-height: 200px;
    }

    /* Ensure any renderer that goes full-height behaves inside viewport */
    .pg-mount > * {
      min-height: 0;
      max-height: 100%;
      overflow: auto;
    }

    /* ----- FOOTER ----- */
    .pg-footer {
      border-top: 1px solid rgb(var(--edu-border));
      background: rgb(var(--edu-card));
      padding: 8px 16px;
      font-size: 12px;
      color: rgb(var(--edu-third-ink));
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .pg-kv { opacity: .8 }
  </style>
</head>
<body>
  <section class="edu-playground" id="pg" data-theme="dark" aria-label="Exercise Playground">
    <!-- Header: contract picker, theme toggle, quick actions -->
    <header class="pg-header">
      <div class="pg-row">
        <select id="pg-contract" class="pg-select" aria-label="Exercise Type"></select>
        <button id="pg-load-example" class="pg-button" title="Load example grammar">Load Example</button>
        <button id="pg-render" class="pg-button" title="Render exercise">Render</button>
      </div>
      <div class="pg-row">
        <label class="pg-toggle">
          <input type="checkbox" id="pg-theme" />
          <span>Light mode</span>
        </label>
      </div>
      <div class="pg-row" id="pg-accents" aria-label="Accent colors"></div>
    </header>

    <!-- App: controls | viewport -->
    <main class="pg-app">
      <section class="pg-controls" aria-label="Editor">
        <div class="pg-row" style="justify-content:space-between">
          <span class="pg-kv">Grammar</span>
          <small class="pg-kv">Trimmed on load</small>
        </div>
        <textarea id="pg-code" class="pg-textarea" placeholder="Write your exercise grammar here..."></textarea>
        <div class="pg-row bottom">
          <button id="pg-clear" class="pg-button" title="Clear">Clear</button>
          <button id="pg-render-2" class="pg-button" title="Render">Render</button>
        </div>
      </section>

      <section class="pg-viewport-wrap">
        <div class="pg-switcher" id="pg-switcher" aria-label="Quick accents"></div>
        <div class="pg-viewport">
          <!-- This wrapper holds the theme variables; renderers mount inside -->
          <div class="pg-mount" id="pg-mount"></div>
        </div>
      </section>
    </main>

    <footer class="pg-footer">
      <span>Only the right pane scrolls; the page does not.</span>
      <span>Theme + accents are scoped to this playground.</span>
    </footer>
  </section>

  <!-- confetti (optional like your demo) -->
  <script src="https://cdn.jsdelivr.net/npm/@tsparticles/confetti@3.0.3/tsparticles.confetti.bundle.min.js"></script>

  <script type="module">
    import {
      ManualContract,
      MatchingContract,
      MatchingWheelsContract,
      MatchingSingleContract,
      ConceptsDefinitionContract,
      TrueFalseContract,
      BlanksSingleContract,
      BlanksReadingContract,
      ColorCategorizeContract
    } from './dist/index.js';

    /** ------- DOM ------- **/
    const $ = (sel, r = document) => r.querySelector(sel);
    const pg = $('#pg');
    const mount = $('#pg-mount');
    const codeEl = $('#pg-code');
    const contractSel = $('#pg-contract');
    const btnLoad = $('#pg-load-example');
    const btnRender = $('#pg-render');
    const btnRender2 = $('#pg-render-2');
    const btnClear = $('#pg-clear');
    const themeToggle = $('#pg-theme');
    const accentsRow = $('#pg-accents');
    const quickRow = $('#pg-switcher');

    /** ------- MENU / CONTRACTS ------- **/
    const menu = [
      ManualContract,
      MatchingContract,
      MatchingWheelsContract,
      MatchingSingleContract,
      ConceptsDefinitionContract,
      TrueFalseContract,
      BlanksSingleContract,
      BlanksReadingContract,
      ColorCategorizeContract
    ];

    // Populate select
    for (const c of menu) {
      const opt = document.createElement('option');
      opt.value = c.name;
      opt.textContent = c.name;
      contractSel.appendChild(opt);
    }
    contractSel.value = menu[0].name;

    /** ------- THEME TOGGLE (scoped) ------- **/
    themeToggle.addEventListener('change', () => {
      pg.setAttribute('data-theme', themeToggle.checked ? 'light' : 'dark');
    });

    /** ------- ACCENTS (scoped to playground wrapper) ------- **/
    const accents = [
      '99 102 241',  // indigo
      '245 158 11',  // amber
      '236 72 153',  // pink
      '59 130 246',  // blue
      '16 185 129',  // emerald
      '249 115 22'   // orange
    ];
    for (const col of accents) {
      const b = document.createElement('button');
      b.className = 'pg-accent';
      b.style.background = `rgb(${col})`;
      b.title = `Accent ${col}`;
      b.addEventListener('click', () => {
        // Set only on the playground container so variables cascade into renderers
        pg.style.setProperty('--edu-first-accent', col);
      });
      accentsRow.appendChild(b);
      // mirror in the quick row (top of viewport)
      quickRow.appendChild(b.cloneNode(true)).addEventListener?.('click', () => {
        pg.style.setProperty('--edu-first-accent', col);
      });
    }

    /** ------- STATE / HANDLER ------- **/
    let current = null; // { destroy():void, name:string, styleTag?:string }
    const byName = Object.fromEntries(menu.map(c => [c.name, c]));

    function currentContract() {
      return byName[contractSel.value];
    }

    function loadExample() {
      const c = currentContract();
      const exampleRaw = (c.grammarExample?.[0] ?? '').toString();
      // Trim edges, keep line breaks
      codeEl.value = exampleRaw.trim();
    }

    function tearDown() {
      if (!current) return;
      // Remove injected style tag if renderer used one
      const styleId = current.styleTag || byName[current.name]?.styleTag;
      if (styleId) {
        const styleEl = document.getElementById(styleId);
        if (styleEl) styleEl.remove();
      }
      // Call destroy if available
      try { current.destroy?.(); } catch {}
      current = null;
      // Clear mount
      mount.innerHTML = '';
    }

    function renderOnce() {
      const c = currentContract();
      if (!c) return;

      // If same contract and already rendered, allow re-render (because code may change)
      tearDown();

      const parser = c.implementation.parser;
      const renderer = c.implementation.renderer;

      const parsed = parser(codeEl.value); // your parser returns { content, ... }
      // Create a fresh mount section for the renderer to own
      const section = document.createElement('section');
      section.setAttribute('role', 'region');
      section.setAttribute('aria-label', `${c.name} Exercise`);
      section.style.minHeight = '0';
      mount.appendChild(section);

      const opts = {
        ...(c.defaultOptions ?? {}),
        resultHandler: () => {
          confetti({ particleCount: 90, spread: 65, origin: { y: 0.6 } });
        },
        ariaLabel: `${c.name} Exercise`
      };

      // Render
      const handle = renderer(section, parsed.content, opts);
      // Persist handler for teardown
      current = {
        name: c.name,
        styleTag: c.styleTag,
        destroy: handle?.destroy ?? (() => {
          // Fallback cleanup
          section.replaceWith(section.cloneNode(false));
        })
      };
    }

    /** ------- Events ------- **/
    btnLoad.addEventListener('click', loadExample);
    btnRender.addEventListener('click', renderOnce);
    btnRender2.addEventListener('click', renderOnce);
    btnClear.addEventListener('click', () => { codeEl.value = ''; });

    contractSel.addEventListener('change', () => {
      // Auto-load example of the selected contract
      loadExample();
    });

    // Keyboard quick render: Ctrl/Cmd+Enter
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') renderOnce();
    });

    /** ------- First load ------- **/
    loadExample();        // put sample grammar
    renderOnce();         // initial render
  </script>
</body>
</html>
